apiVersion: v1
kind: ConfigMap
metadata:
  name: argocd-cmp-avp
  namespace: argocd
  labels:
    app.kubernetes.io/name: argocd-cmp-avp
    app.kubernetes.io/part-of: argocd
    argocd.argoproj.io/cmp-plugin: "avp"
data:
  # CMP v2 plugin definition for Argo CD Vault Plugin
  plugin.yaml: |
    apiVersion: argoproj.io/v1alpha1
    kind: ConfigManagementPlugin
    metadata:
      name: avp
    spec:
      version: v1.1
      discover:
        find:
          command: ["sh", "-c", "ls -1 *.avp.yaml *.avp.yml 2>/dev/null || ls -1 *avp*.yaml 2>/dev/null || true"]
      generate:
        command: ["sh", "-c", "argocd-vault-plugin generate ."]
  vaultAddr: https://vault.tehmatt.com
  kubernetesRole: argocd
  # AVP static config file mounted into the sidecar
  avp-config.yaml: |
    type: vault
    auth_type: kubernetes
    address: https://vault.tehmatt.com
    kubernetes_role: argocd
    kubernetes_token_path: /var/run/secrets/tokens/vault-token
    log_level: info
