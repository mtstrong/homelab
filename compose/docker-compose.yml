version: '3.9'
services:
  traefik:
    container_name: traefik
    image: traefik:latest 
    ports:
      - 80:80
      - 443:443
      - 8080:8080
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - /home/matt/traefik/acme:/acme
      - /home/matt/traefik/logs:/logs

    environment:
      - CF_API_EMAIL=${CF_EMAIL}
      - CF_API_KEY=${CF_API_KEY}

    command:            
      - --api=true
      - --global.checkNewVersion=true
      - --log.level=DEBUG.
      - --log.filePath=/logs/traefik.log
      - --accessLog.filePath=/logs/access.log
      - --accessLog.bufferingSize=100                                     
      - --providers.docker=true
      - --providers.docker.exposedbydefault=false
      - --providers.docker.endpoint=unix:///var/run/docker.sock
      - --entryPoints.console.address=:8080
      - --entryPoints.web.address=:80
      - --entrypoints.websecure.address=:443
      - --entryPoints.web.http.redirections.entryPoint.to=websecure
      - --entryPoints.web.http.redirections.entryPoint.scheme=https
      - --entryPoints.web.http.redirections.entrypoint.permanent=true
      - --certificatesResolvers.letsencrypt.acme.email=${ACME_EMAIL}
      - --certificatesResolvers.letsencrypt.acme.storage=acme/acme.json
      - --certificatesResolvers.letsencrypt.acme.dnsChallenge=true
      - --certificatesResolvers.letsencrypt.acme.dnsChallenge.provider=cloudflare
    labels:
      - traefik.enable=true
      - traefik.http.middlewares.admin.basicauth.users=${TRAEFIK_USERS}
      - traefik.http.routers.thisproxylocal.rule=Host(${TRAEFIK_IP})
      - traefik.http.routers.thisproxylocal.entryPoints=console
      - traefik.http.routers.thisproxylocal.service=api@internal
      - traefik.http.routers.thisproxylocal.middlewares=admin
      - traefik.http.services.thisproxytls.loadbalancer.server.port=8080
      - traefik.http.routers.thisproxytls.rule=Host(`traefik.tehmatt.com`)
      - traefik.http.routers.thisproxytls.entrypoints=websecure
      - traefik.http.routers.thisproxytls.service=api@internal
      - traefik.http.routers.thisproxytls.middlewares=admin
      - traefik.http.routers.thisproxytls.tls.certresolver=letsencrypt
    restart: always

  sonarr:
    image: lscr.io/linuxserver/sonarr:latest
    container_name: sonarr
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=UTC
      - UMASK_SET=022 #optional
    volumes:
      - /home/matt/sonarr:/config
      - tv:/tv
      - nzb-dls:/downloads
    labels:
      - traefik.enable=true
      - traefik.http.routers.sonarr.rule=Host(`sonarr.tehmatt.com`)
      - traefik.http.routers.sonarr.entrypoints=websecure
      - traefik.http.routers.sonarr.tls.certresolver=letsencrypt
    restart: unless-stopped

  radarr:
    image: lscr.io/linuxserver/radarr:latest
    container_name: radarr
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=UTC
      - UMASK_SET=022
    volumes:
      - /home/matt/radarr:/config
      - movies:/movies
      - nzb-dls:/downloads
    labels:
      - traefik.enable=true
      - traefik.http.routers.radarr.rule=Host(`radarr.tehmatt.com`)
      - traefik.http.routers.radarr.entrypoints=websecure
      - traefik.http.routers.radarr.tls.certresolver=letsencrypt
    restart: unless-stopped

  nzbget:
    image: lscr.io/linuxserver/nzbget:latest
    container_name: nzbget
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=UTC
    volumes:
      - /home/matt/nzbget:/config
      - nzb-dls:/downloads
    labels:
      - traefik.enable=true
      - traefik.http.routers.nzbget.rule=Host(`nzb.tehmatt.com`)
      - traefik.http.routers.nzbget.entrypoints=websecure
      - traefik.http.routers.nzbget.tls.certresolver=letsencrypt
    ports:
      - 6789:6789
    restart: unless-stopped

  audiobookshelf:
    image: ghcr.io/advplyr/audiobookshelf:latest
    container_name: audiobookshelf
    ports:
      - 13378:80
    volumes:
      - audiobooks:/audiobooks
      - podcasts:/podcasts
      - /home/matt/audiobookshelf:/config
      - /home/matt/audiobookshelf:/metadata
    labels:
      - traefik.enable=true
      - traefik.http.routers.audiobookshelf.rule=Host(`abs.tehmatt.com`)
      - traefik.http.routers.audiobookshelf.entrypoints=websecure
      - traefik.http.routers.audiobookshelf.tls.certresolver=letsencrypt

  homepage:
    image: ghcr.io/gethomepage/homepage:latest
    container_name: homepage
    environment:
      PUID: 1000
      PGID: 1000
    ports:
      - 3003:3000
    volumes:
      - /home/matt/homepage:/app/config
      - /var/run/docker.sock:/var/run/docker.sock:ro
    labels:
      - traefik.enable=true
      - traefik.http.routers.homepage.rule=Host(`homepage.tehmatt.com`)
      - traefik.http.routers.homepage.entrypoints=websecure
      - traefik.http.routers.homepage.tls.certresolver=letsencrypt
    restart: unless-stopped

  nordlynx:
    image: ghcr.io/bubuntux/nordlynx
    container_name: nordlynx
    cap_add:
      - NET_ADMIN                             # required
      - SYS_MODULE                            # maybe
    environment:
      - PRIVATE_KEY=${NORDLYNX_KEY}
      - QUERY=filters\[servers_groups\]\[identifier\]=legacy_p2p
      - NET_LOCAL=192.168.0.0/16
      - TZ=America/Chicago
    ports:
      - 8089:8089 # qbittorrent web interface
    sysctls:
      - net.ipv4.conf.all.src_valid_mark=1
      - net.ipv4.conf.all.rp_filter=2
      - net.ipv6.conf.all.disable_ipv6=1
    restart: unless-stopped

  qbittorrent:
    image: linuxserver/qbittorrent:latest
    network_mode: service:nordlynx
    container_name: qbittorrent
    depends_on:
      - nordlynx
    environment:
      - WEBUI_PORT=8089
      - PUID=1000
      - PGID=1000
      - TZ=America/Chicago
      - NETWORK=192.168.1.0/24  # So it can be accessed within the local network
        #ports:
        #- 8089:8089
    volumes:
      - /home/matt/qbittorrent:/config
      - torrent-dls:/downloads
    labels:
      - traefik.enable=true
      - traefik.http.routers.qbittorrent.rule=Host(`qt.tehmatt.com`)
      - traefik.http.routers.qbittorrent.entrypoints=websecure
      - traefik.http.routers.qbittorrent.tls.certresolver=letsencrypt
    restart: unless-stopped

  handbrake:
    image: jlesage/handbrake:latest
    container_name: handbrake
    ports:
      - 5800:5800
    volumes:
      - /home/matt/handbrake:/config
      - handbrake:/storage 
      - handbrake:/watch
      - handbrake:/output

  kavita:
    image: jvmilazz0/kavita:latest
    container_name: kavita
    volumes:
      - comics:/comics
      - /home/matt/kavita:/kavita/config
    labels:
      - traefik.enable=true
      - traefik.http.routers.kavita.rule=Host(`kavita.tehmatt.com`)
      - traefik.http.routers.kavita.entrypoints=websecure
      - traefik.http.routers.kavita.tls.certresolver=letsencrypt
    environment:
      - TZ=America/Chicago
    ports:
      - 5005:5000
    restart: unless-stopped

volumes: 
  tv:
    external: true
  movies:
    external: true
  comics:
    external: true
  nzb-dls:
    external: true
  torrent-dls:
    external: true
  audiobooks:
    external: true
  podcasts:
    external: true
  books:
    external: true
  handbrake:
    external: true
