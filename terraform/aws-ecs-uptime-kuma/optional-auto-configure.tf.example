# Optional: Automated Configuration with Terraform
# Add this to your main.tf to automatically configure Uptime Kuma after deployment

# Store admin credentials in AWS Secrets Manager (recommended)
resource "aws_secretsmanager_secret" "uptime_kuma_admin" {
  name_prefix             = "${var.project_name}-admin-"
  description             = "Uptime Kuma admin credentials"
  recovery_window_in_days = 7

  tags = {
    Name = "${var.project_name}-admin-credentials"
  }
}

resource "aws_secretsmanager_secret_version" "uptime_kuma_admin" {
  secret_id = aws_secretsmanager_secret.uptime_kuma_admin.id
  secret_string = jsonencode({
    username = var.admin_username
    password = var.admin_password
  })
}

# Optional: Use null_resource to run configuration script after deployment
# Note: Requires jq and curl to be installed locally
resource "null_resource" "configure_uptime_kuma" {
  count = var.auto_configure ? 1 : 0

  depends_on = [
    aws_ecs_service.uptime_kuma,
    aws_lb_listener.uptime_kuma
  ]

  # Wait for service to be healthy
  provisioner "local-exec" {
    command = <<-EOT
      echo "Waiting for Uptime Kuma to be ready..."
      sleep 60
      
      max_attempts=30
      attempt=0
      
      while [ $attempt -lt $max_attempts ]; do
        if curl -sf "http://${aws_lb.uptime_kuma.dns_name}" > /dev/null; then
          echo "Uptime Kuma is ready!"
          break
        fi
        echo "Attempt $((attempt + 1))/$max_attempts - waiting..."
        sleep 10
        attempt=$((attempt + 1))
      done
      
      if [ $attempt -eq $max_attempts ]; then
        echo "Warning: Uptime Kuma did not become ready in time"
        exit 1
      fi
    EOT
  }

  # Run configuration script
  provisioner "local-exec" {
    command = <<-EOT
      export UPTIME_KUMA_URL="http://${aws_lb.uptime_kuma.dns_name}"
      export ADMIN_USERNAME="${var.admin_username}"
      export ADMIN_PASSWORD="${var.admin_password}"
      
      if [ -f "${path.module}/scripts/configure-uptime-kuma.sh" ]; then
        bash "${path.module}/scripts/configure-uptime-kuma.sh"
      else
        echo "Warning: Configuration script not found"
      fi
    EOT
  }

  triggers = {
    # Re-run if configuration script changes
    script_hash = filemd5("${path.module}/scripts/configure-uptime-kuma.sh")
    # Or always run on apply
    # always_run = timestamp()
  }
}

# Add these variables to variables.tf:
variable "admin_username" {
  description = "Uptime Kuma admin username"
  type        = string
  default     = "admin"
  sensitive   = true
}

variable "admin_password" {
  description = "Uptime Kuma admin password (must be strong)"
  type        = string
  sensitive   = true
  
  validation {
    condition     = length(var.admin_password) >= 8
    error_message = "Admin password must be at least 8 characters long."
  }
}

variable "auto_configure" {
  description = "Automatically configure Uptime Kuma after deployment"
  type        = bool
  default     = false
}
