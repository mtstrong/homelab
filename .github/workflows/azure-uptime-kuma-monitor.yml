name: Azure Uptime Kuma - Drift Detection & Health Monitoring

on:
  schedule:
    - cron: '0 2 * * *'  # Run at 2 AM UTC daily
  workflow_dispatch:  # Allow manual trigger
  pull_request:
    paths:
      - 'azure-uptimekuma/**'
      - '.github/workflows/azure-uptime-kuma-monitor.yml'

env:
  TF_WORKING_DIR: ./azure-uptimekuma
  ARM_USE_OIDC: true

jobs:
  security-scan:
    name: Security Scan (tfsec)
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run tfsec
        uses: aquasecurity/tfsec-action@v1.0.3
        with:
          working_directory: ${{ env.TF_WORKING_DIR }}
          soft_fail: false
          additional_args: --minimum-severity MEDIUM

      - name: Upload tfsec results
        if: always()
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: results.sarif
        continue-on-error: true

  drift-detection:
    name: Infrastructure Drift Detection
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
      id-token: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup OpenTofu
        uses: opentofu/setup-opentofu@v1
        with:
          tofu_version: 1.8.8

      - name: Check Azure Secrets
        id: check_secrets
        run: |
          if [ -z "${{ secrets.AZURE_CLIENT_ID }}" ]; then
            echo "secrets_available=false" >> $GITHUB_OUTPUT
            echo "âš ï¸ Azure secrets not configured - skipping Azure login"
          else
            echo "secrets_available=true" >> $GITHUB_OUTPUT
          fi

      - name: Azure Login (OIDC)
        if: steps.check_secrets.outputs.secrets_available == 'true'
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: OpenTofu Init
        working-directory: ${{ env.TF_WORKING_DIR }}
        run: tofu init

      - name: OpenTofu Plan (Detect Drift)
        id: plan
        working-directory: ${{ env.TF_WORKING_DIR }}
        run: |
          tofu plan -detailed-exitcode -no-color -out=tfplan 2>&1 | tee plan_output.txt
          echo "exitcode=$?" >> $GITHUB_OUTPUT
        continue-on-error: true

      - name: Parse Plan Results
        id: parse
        if: always()
        working-directory: ${{ env.TF_WORKING_DIR }}
        run: |
          if [ -f plan_output.txt ]; then
            # Count changes
            CHANGES=$(grep -E "Plan:|No changes" plan_output.txt || echo "")
            echo "changes<<EOF" >> $GITHUB_OUTPUT
            echo "$CHANGES" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          fi

      - name: Create Issue on Drift Detection
        if: steps.plan.outputs.exitcode == '2'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const planOutput = fs.readFileSync('${{ env.TF_WORKING_DIR }}/plan_output.txt', 'utf8');
            
            // Check if issue already exists
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: ['infrastructure-drift', 'azure-uptime-kuma']
            });
            
            if (issues.data.length === 0) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: 'ðŸš¨ Infrastructure Drift Detected - Azure Uptime Kuma',
                labels: ['infrastructure-drift', 'azure-uptime-kuma', 'needs-investigation'],
                body: `## Infrastructure Drift Detected
            
            **Detected:** ${new Date().toISOString()}
            **Workflow:** [${context.workflow}](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})
            
            ### Plan Output:
            \`\`\`hcl
            ${planOutput.slice(0, 5000)}
            \`\`\`
            
            ### Recommended Actions:
            1. Review the changes above
            2. If drift is expected, run \`tofu apply\` to sync state
            3. If drift is unexpected, investigate manual Azure changes
            4. Close this issue once resolved
            
            ### Quick Commands:
            \`\`\`bash
            cd azure-uptimekuma
            tofu plan    # Review changes
            tofu apply   # Apply if needed
            \`\`\`
            `
              });
            }

      - name: Comment on Success
        if: steps.plan.outputs.exitcode == '0'
        run: echo "âœ… No infrastructure drift detected - infrastructure matches declared state"

  health-tests:
    name: Infrastructure Health Tests
    runs-on: ubuntu-latest
    needs: drift-detection
    if: always()
    permissions:
      contents: read
      id-token: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup OpenTofu
        uses: opentofu/setup-opentofu@v1
        with:
          tofu_version: 1.8.8

      - name: Check Azure Secrets
        id: check_secrets
        run: |
          if [ -z "${{ secrets.AZURE_CLIENT_ID }}" ]; then
            echo "secrets_available=false" >> $GITHUB_OUTPUT
            echo "âš ï¸ Azure secrets not configured - skipping Azure-dependent tests"
          else
            echo "secrets_available=true" >> $GITHUB_OUTPUT
          fi

      - name: Azure Login (OIDC)
        if: steps.check_secrets.outputs.secrets_available == 'true'
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: OpenTofu Init
        working-directory: ${{ env.TF_WORKING_DIR }}
        run: tofu init

      - name: Get Infrastructure Outputs
        id: outputs
        working-directory: ${{ env.TF_WORKING_DIR }}
        run: |
          URL=$(tofu output -raw uptimekuma_url || echo "")
          FQDN=$(tofu output -raw uptimekuma_fqdn || echo "")
          echo "url=$URL" >> $GITHUB_OUTPUT
          echo "fqdn=$FQDN" >> $GITHUB_OUTPUT

      - name: Test - Container Accessibility
        if: steps.outputs.outputs.url != ''
        run: |
          echo "Testing: ${{ steps.outputs.outputs.url }}"
          
          MAX_RETRIES=5
          RETRY_DELAY=10
          
          for i in $(seq 1 $MAX_RETRIES); do
            echo "Attempt $i/$MAX_RETRIES..."
            if curl -f -s -o /dev/null -w "%{http_code}" "${{ steps.outputs.outputs.url }}" | grep -q "200\|301\|302"; then
              echo "âœ… Container is accessible"
              exit 0
            fi
            if [ $i -lt $MAX_RETRIES ]; then
              echo "â³ Waiting ${RETRY_DELAY}s before retry..."
              sleep $RETRY_DELAY
            fi
          done
          
          echo "âŒ Container is not accessible after $MAX_RETRIES attempts"
          exit 1

      - name: Test - DNS Resolution
        if: steps.outputs.outputs.fqdn != ''
        run: |
          echo "Testing DNS for: ${{ steps.outputs.outputs.fqdn }}"
          if nslookup "${{ steps.outputs.outputs.fqdn }}" > /dev/null 2>&1; then
            echo "âœ… DNS resolution successful"
            IP=$(nslookup "${{ steps.outputs.outputs.fqdn }}" | grep -A1 "Name:" | tail -n1 | awk '{print $2}')
            echo "Resolved IP: $IP"
          else
            echo "âŒ DNS resolution failed"
            exit 1
          fi

      - name: Test - HTTP Response Time
        if: steps.outputs.outputs.url != ''
        run: |
          echo "Testing response time for: ${{ steps.outputs.outputs.url }}"
          RESPONSE_TIME=$(curl -o /dev/null -s -w '%{time_total}' "${{ steps.outputs.outputs.url }}" || echo "0")
          echo "Response time: ${RESPONSE_TIME}s"
          
          # Alert if response time > 3 seconds
          if (( $(echo "$RESPONSE_TIME > 3" | bc -l) )); then
            echo "âš ï¸ WARNING: Response time exceeds 3 seconds"
          else
            echo "âœ… Response time is acceptable"
          fi

      - name: Test - Azure Resource Existence
        if: steps.check_secrets.outputs.secrets_available == 'true'
        run: |
          echo "Verifying Azure resources exist..."
          
          # Check resource group
          if az group show --name rg-uptimekuma-monitoring &>/dev/null; then
            echo "âœ… Resource group exists"
          else
            echo "âŒ Resource group not found"
            exit 1
          fi
          
          # Check container group
          CONTAINER_STATUS=$(az container show \
            --resource-group rg-uptimekuma-monitoring \
            --name uptimekuma \
            --query "instanceView.state" -o tsv 2>/dev/null || echo "NotFound")
          
          echo "Container status: $CONTAINER_STATUS"
          
          if [ "$CONTAINER_STATUS" = "Running" ]; then
            echo "âœ… Container is running"
          else
            echo "âŒ Container is not running (Status: $CONTAINER_STATUS)"
            exit 1
          fi

      - name: Test - Storage Account Accessibility
        if: steps.check_secrets.outputs.secrets_available == 'true'
        run: |
          echo "Verifying storage account..."
          
          # Get storage account name dynamically
          STORAGE_NAME=$(az storage account list \
            --resource-group rg-uptimekuma-monitoring \
            --query "[0].name" -o tsv 2>/dev/null || echo "NotFound")
          
          STORAGE_EXISTS=$(az storage account show \
            --name "$STORAGE_NAME" \
            --resource-group rg-uptimekuma-monitoring \
            --query "name" -o tsv 2>/dev/null || echo "NotFound")
          
          if [ "$STORAGE_EXISTS" != "NotFound" ]; then
            echo "âœ… Storage account exists"
          else
            echo "âŒ Storage account not found"
            exit 1
          fi

  cost-report:
    name: Azure Cost Report
    runs-on: ubuntu-latest
    needs: health-tests
    if: always()
    permissions:
      contents: read
      id-token: write
    
    steps:
      - name: Check Azure Secrets
        id: check_secrets
        run: |
          if [ -z "${{ secrets.AZURE_CLIENT_ID }}" ]; then
            echo "secrets_available=false" >> $GITHUB_OUTPUT
            echo "âš ï¸ Azure secrets not configured - skipping cost report"
            exit 0
          else
            echo "secrets_available=true" >> $GITHUB_OUTPUT
          fi

      - name: Azure Login (OIDC)
        if: steps.check_secrets.outputs.secrets_available == 'true'
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Get Current Month Costs
        if: steps.check_secrets.outputs.secrets_available == 'true'
        run: |
          echo "ðŸ“Š Azure Uptime Kuma Cost Report"
          echo "================================"
          
          # Get resource group costs for current month
          COSTS=$(az consumption usage list \
            --start-date $(date -u -d "$(date +%Y-%m-01)" +%Y-%m-%d) \
            --end-date $(date -u +%Y-%m-%d) \
            --query "[?contains(instanceId, 'rg-uptimekuma-monitoring')].{Resource:instanceName, Cost:pretaxCost, Currency:currency}" \
            --output table 2>/dev/null || echo "Cost data not available")
          
          echo "$COSTS"
          echo ""
          echo "ðŸ’¡ To set up budget alerts, configure Azure Budget in the Portal"

  summary:
    name: Monitoring Summary
    runs-on: ubuntu-latest
    needs: [security-scan, drift-detection, health-tests, cost-report]
    if: always()
    permissions:
      contents: read
    
    steps:
      - name: Generate Summary
        run: |
          echo "## ðŸ” Azure Uptime Kuma Monitoring Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Run Date:** $(date -u)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Job Results" >> $GITHUB_STEP_SUMMARY
          echo "- Security Scan: ${{ needs.security-scan.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Drift Detection: ${{ needs.drift-detection.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Health Tests: ${{ needs.health-tests.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Cost Report: ${{ needs.cost-report.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Quick Links" >> $GITHUB_STEP_SUMMARY
          echo "- [View Uptime Kuma](http://mthomelabmonitor.eastus.azurecontainer.io:3001)" >> $GITHUB_STEP_SUMMARY
          echo "- [Azure Portal - Resource Group](https://portal.azure.com/#@/resource/subscriptions/${{ secrets.AZURE_SUBSCRIPTION_ID }}/resourceGroups/rg-uptimekuma-monitoring)" >> $GITHUB_STEP_SUMMARY
